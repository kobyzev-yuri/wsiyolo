# 🔄 Блок-схема текущего алгоритма WSI YOLO Pipeline

## 📋 Общая схема алгоритма

```
┌─────────────────────────────────────────────────────────────────┐
│                    WSI YOLO Pipeline                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. Инициализация Pipeline                                      │
│    - Загрузка моделей (lp.pt, mild.pt, moderate.pt)            │
│    - Настройка параметров (tile_size=512, overlap=0.5)         │
│    - Инициализация компонентов                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. Загрузка WSI                                                │
│    - Открытие WSI файла                                        │
│    - Получение метаданных (размер, уровни, MPP)                │
│    - Создание WSIInfo объекта                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. Извлечение патчей                                           │
│    - GridPatchd с threshold=0.999*3*255*512*512               │
│    - Фильтрация пустых патчей                                  │
│    - Создание PatchInfo объектов                               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. Обработка патчей (ПОСЛЕДОВАТЕЛЬНО)                         │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ for patch in patches:                                  │   │
│    │     ┌─────────────────────────────────────────────────┐ │   │
│    │     │ 5. Применение ВСЕХ моделей к патчу            │ │   │
│    │     │    ┌─────────────────────────────────────────┐ │ │   │
│    │     │    │ for model in models:                   │ │ │   │
│    │     │    │     ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │     │ 6. YOLO инференс                │ │ │ │   │
│    │     │    │     │    - conf=model.min_conf        │ │ │ │   │
│    │     │    │     │    - iou=0.5 (NMS)             │ │ │ │   │
│    │     │    │     │    - max_det=100                │ │ │ │   │
│    │     │    │     │    - verbose=False              │ │ │ │   │
│    │     │    │     └─────────────────────────────────┘ │ │ │   │
│    │     │    │     ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │     │ 7. Обработка результатов       │ │ │ │   │
│    │     │    │     │    - Сегментация (masks)       │ │ │ │   │
│    │     │    │     │    - Детекция (boxes)          │ │ │ │   │
│    │     │    │     │    - Фильтрация по размеру     │ │ │ │   │
│    │     │    │     │    - Создание полигонов         │ │ │ │   │
│    │     │    │     └─────────────────────────────────┘ │ │ │   │
│    │     │    └─────────────────────────────────────────┘ │ │   │
│    │     │    ┌─────────────────────────────────────────┐ │ │   │
│    │     │    │ 8. Упрощение полигонов                  │ │ │   │
│    │     │    │    - Бинарный поиск tolerance          │ │ │   │
│    │     │    │    - Упрощение до 60 точек             │ │ │   │
│    │     │    │    - Fallback: равномерная выборка     │ │ │   │
│    │     │    └─────────────────────────────────────────┘ │ │   │
│    │     └─────────────────────────────────────────────────┘ │   │
│    │     ┌─────────────────────────────────────────────────┐ │   │
│    │     │ 9. Сбор предсказаний                           │ │   │
│    │     │    - Добавление в all_predictions             │ │   │
│    │     │    - Преобразование координат                 │ │   │
│    │     └─────────────────────────────────────────────────┘ │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 10. Объединение предсказаний                                   │
│     - Группировка по классам                                   │
│     - Создание Shapely полигонов                               │
│     - unary_union для объединения                              │
│     - IoU фильтрация дубликатов                                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 11. Сохранение результатов                                     │
│     - Создание JSON структуры                                  │
│     - Сохранение в predictions.json                            │
│     - Генерация статистики                                     │
└─────────────────────────────────────────────────────────────────┘
```

## 🔍 Детальная схема применения моделей

### Текущий алгоритм (ПОСЛЕДОВАТЕЛЬНЫЙ)

```
Патч 1 ──┐
         ├── Модель 1 (lp.pt)     ──┐
         ├── Модель 2 (mild.pt)   ──┼── Все предсказания патча 1
         └── Модель 3 (moderate.pt)──┘
         
Патч 2 ──┐
         ├── Модель 1 (lp.pt)     ──┐
         ├── Модель 2 (mild.pt)   ──┼── Все предсказания патча 2
         └── Модель 3 (moderate.pt)──┘
         
Патч 3 ──┐
         ├── Модель 1 (lp.pt)     ──┐
         ├── Модель 2 (mild.pt)   ──┼── Все предсказания патча 3
         └── Модель 3 (moderate.pt)──┘
         
         ... (для всех N патчей)
```

### Проблемы текущего подхода

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМЫ ПРОИЗВОДИТЕЛЬНОСТИ                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ 1. НЕЭФФЕКТИВНОЕ ИСПОЛЬЗОВАНИЕ GPU:                           │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ GPU Utilization: 10-20%                                 │   │
│    │ Причина: Один патч не заполняет GPU                     │   │
│    │ Решение: Батчинг патчей                                 │   │
│    └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│ 2. МНОЖЕСТВЕННЫЕ ВЫЗОВЫ МОДЕЛЕЙ:                               │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ Количество вызовов: N × M                               │   │
│    │ Где N = патчи, M = модели                               │   │
│    │ Пример: 1000 патчей × 3 модели = 3000 вызовов          │   │
│    └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│ 3. ОТСУТСТВИЕ БАТЧИНГА:                                        │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ Каждый патч обрабатывается отдельно                     │   │
│    │ Нет группировки для эффективной обработки              │   │
│    │ Потеря производительности GPU                           │   │
│    └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│ 4. ПОСЛЕДОВАТЕЛЬНАЯ ОБРАБОТКА МОДЕЛЕЙ:                         │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ Модели применяются последовательно                     │   │
│    │ Нет параллелизации между моделями                       │   │
│    │ Увеличение времени обработки                            │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 Рекомендуемая оптимизированная схема

### Батчинг по моделям

```
┌─────────────────────────────────────────────────────────────────┐
│                    ОПТИМИЗИРОВАННЫЙ АЛГОРИТМ                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Модель 1 (lp.pt):                                               │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Модель 2 (mild.pt):                                             │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Модель 3 (moderate.pt):                                         │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### Параллельная обработка моделей

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПАРАЛЛЕЛЬНАЯ ОБРАБОТКА                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Батч патчей: [Патч 1, Патч 2, ..., Патч 16]                   │
│                                                                 │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│ │ Модель 1    │  │ Модель 2    │  │ Модель 3    │              │
│ │ (lp.pt)     │  │ (mild.pt)   │  │ (moderate.pt)│              │
│ │             │  │             │  │             │              │
│ │ Батч 1 ─────┼──┼─────────────┼──┼─────────────┼───┐          │
│ │ [1,2,...,16]│  │ Батч 1      │  │ Батч 1      │  │          │
│ │             │  │ [1,2,...,16] │  │ [1,2,...,16] │  │          │
│ └─────────────┘  └─────────────┘  └─────────────┘  │          │
│                                                   │          │
│ ┌─────────────────────────────────────────────────┼──────────┘  │
│ │              Объединение результатов            │             │
│ │              всех моделей для батча            │             │
│ └─────────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 Сравнение производительности

### Текущий алгоритм

```
Время обработки:
┌─────────────────────────────────────────────────────────────────┐
│ Патч 1: Модель 1 (100ms) + Модель 2 (100ms) + Модель 3 (100ms) │
│ Патч 2: Модель 1 (100ms) + Модель 2 (100ms) + Модель 3 (100ms) │
│ Патч 3: Модель 1 (100ms) + Модель 2 (100ms) + Модель 3 (100ms) │
│ ...                                                             │
│ Итого: N × M × 100ms = 1000 × 3 × 100ms = 300,000ms = 5 мин   │
└─────────────────────────────────────────────────────────────────┘

GPU Utilization: 10-20%
Memory Usage: Низкая
Model Calls: N × M = 3000
```

### Оптимизированный алгоритм

```
Время обработки:
┌─────────────────────────────────────────────────────────────────┐
│ Модель 1: (N/16) × 50ms = 62.5 × 50ms = 3,125ms               │
│ Модель 2: (N/16) × 50ms = 62.5 × 50ms = 3,125ms               │
│ Модель 3: (N/16) × 50ms = 62.5 × 50ms = 3,125ms               │
│ Итого: 9,375ms = 9.4 сек (в 32 раза быстрее!)                  │
└─────────────────────────────────────────────────────────────────┘

GPU Utilization: 80-95%
Memory Usage: Средняя
Model Calls: M × (N/16) = 3 × 62.5 = 187.5
```

## 🎯 Ключевые улучшения

### 1. Батчинг патчей
- **Текущий**: 1 патч за раз
- **Оптимизированный**: 16-32 патча за раз
- **Ускорение**: 3-5x

### 2. Параллелизация моделей
- **Текущий**: Последовательно
- **Оптимизированный**: Параллельно
- **Ускорение**: 2-3x

### 3. Эффективное использование GPU
- **Текущий**: 10-20% утилизация
- **Оптимизированный**: 80-95% утилизация
- **Ускорение**: 4-5x

### 4. Уменьшение вызовов моделей
- **Текущий**: N × M вызовов
- **Оптимизированный**: M × (N/B) вызовов
- **Уменьшение**: в 16 раз (при batch_size=16)

## 🔧 Практическая реализация

### Конфигурация батчинга

```python
BATCH_CONFIG = {
    'batch_size': 16,              # Оптимальный размер батча
    'max_batch_size': 32,          # Максимальный размер
    'min_batch_size': 4,           # Минимальный размер
    'memory_threshold': 0.8,        # Порог использования памяти
    'adaptive_batching': True,      # Адаптивный размер батча
    'parallel_models': True,        # Параллельная обработка моделей
}
```

### Адаптивный размер батча

```python
def calculate_batch_size(gpu_memory_gb: float, patch_size: int) -> int:
    """Вычисляет оптимальный размер батча"""
    if gpu_memory_gb >= 24 and patch_size == 512:
        return 32
    elif gpu_memory_gb >= 16 and patch_size == 512:
        return 16
    elif gpu_memory_gb >= 8 and patch_size == 512:
        return 8
    else:
        return 4
```

### Обработка ошибок памяти

```python
def process_with_fallback(batch_patches, initial_batch_size):
    """Обработка с fallback при нехватке памяти"""
    try:
        return process_batch(batch_patches, initial_batch_size)
    except torch.cuda.OutOfMemoryError:
        # Уменьшаем размер батча
        smaller_batch_size = initial_batch_size // 2
        if smaller_batch_size >= 1:
            return process_batch(batch_patches, smaller_batch_size)
        else:
            # Обрабатываем по одному патчу
            return [process_single_patch(patch) for patch in batch_patches]
```
