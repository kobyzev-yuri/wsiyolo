# 🔄 Блок-схема алгоритма мульти-модельного YOLO предикта

## 📋 Общая архитектура WSI YOLO Pipeline

```
┌─────────────────────────────────────────────────────────────────┐
│                    WSI YOLO MULTI-MODEL PIPELINE                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 1. ИНИЦИАЛИЗАЦИЯ СИСТЕМЫ                                        │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ • Загрузка конфигурации моделей                         │   │
│    │ • Инициализация YOLOInference с 3 моделями:             │   │
│    │   - lp.pt (confidence=0.5)                              │   │
│    │   - mild.pt (confidence=0.6)                             │   │
│    │   - moderate.pt (confidence=0.7)                        │   │
│    │ • Настройка WSIPipeline (tile_size=512, overlap=0.5)    │   │
│    │ • Инициализация PolygonMerger (iou_threshold=0.5)      │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 2. ЗАГРУЗКА WSI ФАЙЛА                                          │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ • Открытие WSI файла (CuCIMWSIReader)                  │   │
│    │ • Извлечение метаданных:                               │   │
│    │   - Размеры (width, height)                            │   │
│    │   - Количество уровней (levels)                        │   │
│    │   - MPP (микрометры на пиксель)                        │   │
│    │ • Создание WSIInfo объекта                             │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 3. ИЗВЛЕЧЕНИЕ ПАТЧЕЙ                                          │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ • GridPatchd с параметрами:                           │   │
│    │   - patch_size=(512, 512)                              │   │
│    │   - threshold=0.999*3*255*512*512                     │   │
│    │   - pad_mode=None                                       │   │
│    │ • Фильтрация пустых патчей                             │   │
│    │ • Создание PatchInfo объектов с координатами           │   │
│    │ • Результат: List[PatchInfo]                           │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 4. ОСНОВНОЙ ЦИКЛ ОБРАБОТКИ ПАТЧЕЙ (ПОСЛЕДОВАТЕЛЬНО)            │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ for patch in tqdm(patches, desc="Обработка патчей"):    │   │
│    │     ┌─────────────────────────────────────────────────┐ │   │
│    │     │ 5. ПРИМЕНЕНИЕ ВСЕХ МОДЕЛЕЙ К ПАТЧУ            │ │   │
│    │     │    ┌─────────────────────────────────────────┐ │ │   │
│    │     │    │ for model_path, model_data in           │ │ │   │
│    │     │    │     self.loaded_models.items():         │ │ │   │
│    │     │    │     ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │     │ 6. YOLO ИНФЕРЕНС                 │ │ │ │   │
│    │     │    │     │    ┌─────────────────────────┐ │ │ │ │   │
│    │     │    │     │    │ • Проверка размера       │ │ │ │ │   │
│    │     │    │     │    │   patch.size ==          │ │ │ │ │   │
│    │     │    │     │    │   model.window_size      │ │ │ │ │   │
│    │     │    │     │    └─────────────────────────┘ │ │ │ │   │
│    │     │    │     │    ┌─────────────────────────┐ │ │ │ │   │
│    │     │    │     │    │ • Вызов модели:         │ │ │ │ │   │
│    │     │    │     │    │   model(patch.image,    │ │ │ │ │   │
│    │     │    │     │    │     conf=model.min_conf,│ │ │ │ │   │
│    │     │    │     │    │     iou=0.5,            │ │ │ │ │   │
│    │     │    │     │    │     max_det=100,        │ │ │ │ │   │
│    │     │    │     │    │     verbose=False)      │ │ │ │ │   │
│    │     │    │     │    └─────────────────────────┘ │ │ │ │   │
│    │     │    │     └─────────────────────────────────┘ │ │ │   │
│    │     │    │     ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │     │ 7. ОБРАБОТКА РЕЗУЛЬТАТОВ       │ │ │ │   │
│    │     │    │     │    ┌─────────────────────────┐ │ │ │ │   │
│    │     │    │     │    │ if result.masks:        │ │ │ │ │   │
│    │     │    │     │    │   • Обработка сегментации│ │ │ │ │   │
│    │     │    │     │    │   • Извлечение масок     │ │ │ │ │   │
│    │     │    │     │    │   • Создание полигонов   │ │ │ │ │   │
│    │     │    │    │    └─────────────────────────┘ │ │ │ │   │
│    │     │    │    │    ┌─────────────────────────┐ │ │ │ │   │
│    │     │    │    │    │ else:                   │ │ │ │ │   │
│    │     │    │    │    │   • Обработка детекции   │ │ │ │ │   │
│    │     │    │    │    │   • Только bounding boxes│ │ │ │ │   │
│    │     │    │    │    └─────────────────────────┘ │ │ │ │   │
│    │     │    │    └─────────────────────────────────┘ │ │ │   │
│    │     │    └─────────────────────────────────────────┘ │ │   │
│    │     │    ┌─────────────────────────────────────────┐ │ │   │
│    │     │    │ 8. СОЗДАНИЕ ПОЛИГОНОВ ИЗ МАСОК        │ │ │   │
│    │     │    │    ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │    │ • find_contours(mask, 0.5)     │ │ │ │   │
│    │     │    │    │ • Выбор самого большого контура│ │ │ │   │
│    │     │    │    │ • Преобразование координат      │ │ │ │   │
│    │     │    │    │ • Создание Shapely Polygon      │ │ │ │   │
│    │     │    │    └─────────────────────────────────┘ │ │ │   │
│    │     │    │    ┌─────────────────────────────────┐ │ │ │   │
│    │     │    │    │ • УМНОЕ УПРОЩЕНИЕ ПОЛИГОНОВ:   │ │ │ │   │
│    │     │    │    │   - Бинарный поиск tolerance   │ │ │ │   │
│    │     │    │    │   - Упрощение до 60 точек      │ │ │ │   │
│    │     │    │    │   - Fallback: равномерная      │ │ │ │   │
│    │     │    │    │     выборка                     │ │ │ │   │
│    │     │    │    └─────────────────────────────────┘ │ │ │   │
│    │     │    └─────────────────────────────────────────┘ │ │   │
│    │     │    ┌─────────────────────────────────────────┐ │ │   │
│    │     │    │ 9. ФИЛЬТРАЦИЯ ПО РАЗМЕРУ               │ │ │   │
│    │     │    │    • bbox_width >= 20                  │ │ │   │
│    │     │    │    • bbox_height >= 20                 │ │ │   │
│    │     │    │    • Создание Prediction объектов     │ │ │   │
│    │     │    └─────────────────────────────────────────┘ │ │   │
│    │     └─────────────────────────────────────────────────┘ │   │
│    │     ┌─────────────────────────────────────────────────┐ │   │
│    │     │ 10. СБОР ПРЕДСКАЗАНИЙ ОТ ВСЕХ МОДЕЛЕЙ         │ │   │
│    │     │     • Добавление в all_predictions            │ │   │
│    │     │     • Преобразование в абсолютные координаты  │ │   │
│    │     │     • Сохранение метаданных (класс, уверенность)│ │   │
│    │     └─────────────────────────────────────────────────┘ │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 11. ОБЪЕДИНЕНИЕ ПЕРЕКРЫВАЮЩИХСЯ ПРЕДСКАЗАНИЙ                   │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ • Группировка по классам                               │   │
│    │ • Создание Shapely полигонов                           │   │
│    │ • unary_union для объединения                          │   │
│    │ • IoU фильтрация дубликатов (threshold=0.5)            │   │
│    │ • Фильтрация по минимальной площади (min_area=10.0)    │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│ 12. СОХРАНЕНИЕ РЕЗУЛЬТАТОВ                                    │
│    ┌─────────────────────────────────────────────────────────┐   │
│    │ • Создание JSON структуры:                             │   │
│    │   - wsi_info (метаданные WSI)                          │   │
│    │   - predictions (массив предсказаний)                  │   │
│    │ • Сохранение в predictions.json                        │   │
│    │ • Генерация статистики                                 │   │
│    └─────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

## 🔍 Детальная схема применения моделей

### Текущий алгоритм (ПОСЛЕДОВАТЕЛЬНЫЙ)

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПАТЧ 1                                       │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│ │ Модель 1    │  │ Модель 2    │  │ Модель 3    │              │
│ │ (lp.pt)     │  │ (mild.pt)   │  │ (moderate.pt)│              │
│ │ conf=0.5    │  │ conf=0.6    │  │ conf=0.7    │              │
│ │             │  │             │  │             │              │
│ │ YOLO ───────┼──┼─────────────┼──┼─────────────┼───┐          │
│ │ inference   │  │ YOLO        │  │ YOLO        │  │          │
│ │             │  │ inference   │  │ inference   │  │          │
│ └─────────────┘  └─────────────┘  └─────────────┘  │          │
│                                                   │          │
│ ┌─────────────────────────────────────────────────┼──────────┘  │
│ │              Сбор всех предсказаний            │             │
│ │              для патча 1                       │             │
│ └─────────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ПАТЧ 2                                       │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│ │ Модель 1    │  │ Модель 2    │  │ Модель 3    │              │
│ │ (lp.pt)     │  │ (mild.pt)   │  │ (moderate.pt)│              │
│ │ conf=0.5    │  │ conf=0.6    │  │ conf=0.7    │              │
│ │             │  │             │  │             │              │
│ │ YOLO ───────┼──┼─────────────┼──┼─────────────┼───┐          │
│ │ inference   │  │ YOLO        │  │ YOLO        │  │          │
│ │             │  │ inference   │  │ inference   │  │          │
│ └─────────────┘  └─────────────┘  └─────────────┘  │          │
│                                                   │          │
│ ┌─────────────────────────────────────────────────┼──────────┘  │
│ │              Сбор всех предсказаний            │             │
│ │              для патча 2                       │             │
│ └─────────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ... (для всех N патчей)                      │
└─────────────────────────────────────────────────────────────────┘
```

## ⚠️ Проблемы текущего алгоритма

### 1. Неэффективное использование GPU

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА: НИЗКАЯ УТИЛИЗАЦИЯ GPU              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Текущее состояние:                                              │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ GPU Utilization: 10-20%                                     │ │
│ │ Причина: Один патч 512x512 не заполняет GPU                 │ │
│ │ Результат: Потеря производительности                        │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Решение: Батчинг патчей                                        │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч из 16 патчей: 16 × 512 × 512 = 4,194,304 пикселей     │ │
│ │ GPU Utilization: 80-95%                                     │ │
│ │ Ускорение: 4-5x                                             │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 2. Множественные вызовы моделей

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА: ИЗБЫТОЧНЫЕ ВЫЗОВЫ                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Текущий алгоритм:                                              │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Количество вызовов: N × M                                  │ │
│ │ Где N = количество патчей                                   │ │
│ │      M = количество моделей                                 │ │
│ │                                                             │ │
│ │ Пример: 1000 патчей × 3 модели = 3000 вызовов              │ │
│ │ Каждый вызов обрабатывает только 1 патч                    │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Оптимизированный алгоритм:                                     │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Количество вызовов: M × (N/B)                              │ │
│ │ Где B = размер батча                                       │ │
│ │                                                             │ │
│ │ Пример: 3 модели × (1000/16) = 3 × 62.5 = 187.5 вызовов   │ │
│ │ Каждый вызов обрабатывает 16 патчей                        │ │
│ │ Уменьшение в 16 раз!                                        │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### 3. Последовательная обработка моделей

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПРОБЛЕМА: ОТСУТСТВИЕ ПАРАЛЛЕЛИЗМА           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Текущий алгоритм:                                              │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Патч → Модель 1 → Модель 2 → Модель 3                     │ │
│ │ Время: 100ms + 100ms + 100ms = 300ms на патч              │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Оптимизированный алгоритм:                                     │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч → [Модель 1, Модель 2, Модель 3] (параллельно)       │ │
│ │ Время: max(100ms, 100ms, 100ms) = 100ms на батч           │ │
│ │ Ускорение: 3x                                               │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🚀 Рекомендуемая оптимизированная схема

### Батчинг по моделям

```
┌─────────────────────────────────────────────────────────────────┐
│                    ОПТИМИЗИРОВАННЫЙ АЛГОРИТМ                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Модель 1 (lp.pt):                                               │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Модель 2 (mild.pt):                                             │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ Модель 3 (moderate.pt):                                         │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Батч 1: [Патч 1, Патч 2, ..., Патч 16] ──┐                │ │
│ │ Батч 2: [Патч 17, Патч 18, ..., Патч 32] ──┼── Все         │ │
│ │ Батч 3: [Патч 33, Патч 34, ..., Патч 48] ──┘   предсказания │ │
│ │ ... (N/16 батчей)                                      │ │
│ └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

### Параллельная обработка моделей

```
┌─────────────────────────────────────────────────────────────────┐
│                    ПАРАЛЛЕЛЬНАЯ ОБРАБОТКА                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Батч патчей: [Патч 1, Патч 2, ..., Патч 16]                   │
│                                                                 │
│ ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│ │ Модель 1    │  │ Модель 2    │  │ Модель 3    │              │
│ │ (lp.pt)     │  │ (mild.pt)   │  │ (moderate.pt)│              │
│ │             │  │             │  │             │              │
│ │ Батч 1 ─────┼──┼─────────────┼──┼─────────────┼───┐          │
│ │ [1,2,...,16]│  │ Батч 1      │  │ Батч 1      │  │          │
│ │             │  │ [1,2,...,16] │  │ [1,2,...,16] │  │          │
│ └─────────────┘  └─────────────┘  └─────────────┘  │          │
│                                                   │          │
│ ┌─────────────────────────────────────────────────┼──────────┘  │
│ │              Объединение результатов            │             │
│ │              всех моделей для батча            │             │
│ └─────────────────────────────────────────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 Сравнение производительности

### Текущий алгоритм

```
┌─────────────────────────────────────────────────────────────────┐
│                    ТЕКУЩИЙ АЛГОРИТМ                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Время обработки:                                                │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Патч 1: Модель 1 (100ms) + Модель 2 (100ms) + Модель 3   │ │
│ │         (100ms) = 300ms                                   │ │
│ │ Патч 2: Модель 1 (100ms) + Модель 2 (100ms) + Модель 3   │ │
│ │         (100ms) = 300ms                                   │ │
│ │ ...                                                       │ │
│ │ Итого: N × M × 100ms = 1000 × 3 × 100ms = 300,000ms      │ │
│ │ = 5 минут                                                 │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ GPU Utilization: 10-20%                                         │
│ Memory Usage: Низкая                                           │
│ Model Calls: N × M = 3000                                      │
└─────────────────────────────────────────────────────────────────┘
```

### Оптимизированный алгоритм

```
┌─────────────────────────────────────────────────────────────────┐
│                    ОПТИМИЗИРОВАННЫЙ АЛГОРИТМ                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Время обработки:                                                │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Модель 1: (N/16) × 50ms = 62.5 × 50ms = 3,125ms           │ │
│ │ Модель 2: (N/16) × 50ms = 62.5 × 50ms = 3,125ms           │ │
│ │ Модель 3: (N/16) × 50ms = 62.5 × 50ms = 3,125ms           │ │
│ │ Итого: 9,375ms = 9.4 секунды                               │ │
│ │ Ускорение: в 32 раза!                                       │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│ GPU Utilization: 80-95%                                        │
│ Memory Usage: Средняя                                          │
│ Model Calls: M × (N/16) = 3 × 62.5 = 187.5                    │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 Ключевые улучшения

### 1. Батчинг патчей
- **Текущий**: 1 патч за раз
- **Оптимизированный**: 16-32 патча за раз
- **Ускорение**: 3-5x

### 2. Параллелизация моделей
- **Текущий**: Последовательно
- **Оптимизированный**: Параллельно
- **Ускорение**: 2-3x

### 3. Эффективное использование GPU
- **Текущий**: 10-20% утилизация
- **Оптимизированный**: 80-95% утилизация
- **Ускорение**: 4-5x

### 4. Уменьшение вызовов моделей
- **Текущий**: N × M вызовов
- **Оптимизированный**: M × (N/B) вызовов
- **Уменьшение**: в 16 раз (при batch_size=16)

## 🔧 Практическая реализация

### Конфигурация батчинга

```python
BATCH_CONFIG = {
    'batch_size': 16,              # Оптимальный размер батча
    'max_batch_size': 32,          # Максимальный размер
    'min_batch_size': 4,           # Минимальный размер
    'memory_threshold': 0.8,        # Порог использования памяти
    'adaptive_batching': True,      # Адаптивный размер батча
    'parallel_models': True,        # Параллельная обработка моделей
}
```

### Адаптивный размер батча

```python
def calculate_batch_size(gpu_memory_gb: float, patch_size: int) -> int:
    """Вычисляет оптимальный размер батча"""
    if gpu_memory_gb >= 24 and patch_size == 512:
        return 32
    elif gpu_memory_gb >= 16 and patch_size == 512:
        return 16
    elif gpu_memory_gb >= 8 and patch_size == 512:
        return 8
    else:
        return 4
```

### Обработка ошибок памяти

```python
def process_with_fallback(batch_patches, initial_batch_size):
    """Обработка с fallback при нехватке памяти"""
    try:
        return process_batch(batch_patches, initial_batch_size)
    except torch.cuda.OutOfMemoryError:
        # Уменьшаем размер батча
        smaller_batch_size = initial_batch_size // 2
        if smaller_batch_size >= 1:
            return process_batch(batch_patches, smaller_batch_size)
        else:
            # Обрабатываем по одному патчу
            return [process_single_patch(patch) for patch in batch_patches]
```

## 📈 Ожидаемые результаты оптимизации

### Производительность
- **Ускорение**: 20-50x
- **GPU утилизация**: 80-95%
- **Память**: Оптимальное использование

### Масштабируемость
- **Большие WSI**: Эффективная обработка
- **Множественные модели**: Параллельная обработка
- **Адаптивность**: Автоматическая настройка

### Надежность
- **Обработка ошибок**: Fallback стратегии
- **Управление памятью**: Автоматическое масштабирование
- **Мониторинг**: Детальная статистика
